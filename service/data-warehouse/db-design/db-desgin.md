安个家数据仓库概述
================


## 1、数据仓库数据分层概述

```
目标

1.上游系统信息需要保留完整，不能丢失信息，不能转换错误信息；

2.第三范式建模，去除冗余信息；

3.需要考虑数据仓库自身加载性能，以及对外服务窗口；

4.模型灵活

5.模型方便扩展

6.模型稳定

```

安个家的数据仓库使用3NF方式设计


数据粒度采用双重粒度:即低细节级和高细节级


数据库设计包含MySQL和Hive两部分


整体数据仓库放置HADOOP平台的Hive


思路：整体ETL处理过程使用Hadoop的Hive，ETL结果及展示使用MYSQL



## 2、数据仓库数据库结构


```

数据仓库 数据库基本功能划分

A.数据仓库 库结构及说明

B.Hive功能库说明

C.数据来源

```

一、数据仓库 库结构及说明

| 编号 | Hive数据库名称 | MySQL数据库名称 | 数据粒度 | 数据仓库定义层级 | 作用 | 存放数据类型 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | dw_stage | dw_stage | 数据仓库明细数据 | DWD | ETL过程处理后的明细数据 | 明细数据 |
| 2 | dw_db | dw_db | 数据仓库汇总数据、维度信息  | DWS | ETL过程处理后的数据 包含汇总数据、维度数据、通用层数据 | 基础指标类数据 |
| 3 | da_db | da_db | 数据仓库提供外部使用数据  | DWA | 数据仓库处理后提供的应用层数据 | 衍生数据 |
| 4 | dw_db_temp | dw_db_temp | 数据仓库临时库 | DWT | 数据仓库中ETL处理的临时库 | 临时数据 |
| 5 | dw_temp_angejia | dw_temp_angejia | 数据仓库临时库 | DWT | DWMS的MiniReport的临时处理过程数据 | 临时数据 |

二、Hive功能库说明

| 编号 | Hive数据库名称 | 作用 | 数据仓库定义 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | db_sync | 存放 mysql 同步数据库，每天更新一次 | 同步库 |
| 2 | db_snapshoot | 存放 mysql 数据，按照每天的快照存放 | 快照库 |
| 3 | db_gather | 快照库(db_snapshoot)中，相同的表，所有的日期放到一张表中，提供查询 | 聚合库 |

[数据库详细说明](/docs/service/dw-databases/table-design/detail-tables/readme.md)

## 3、脚本编写规范及调度

sql编码规范

1 目的

为了保证所每个项目组编写出的程序都符合相同的规范，便于理解和维护，便于检查、减少出错概率，有助于成员间交流，保证一致性、统一性而建立的sql程序编码规范。

2 范围

该规范适用于所有需要基于sql开发的项目。

3 书写规范

3.1 总体命名规范

  	1.名称的使用英文完整单词标示所属内容。
  	2.名称采用英文单词、英文单词和数字，单词之间用“_”分隔。
  	3.数据库对象名称所有字母必须小写。
  	4.不得采用“_”作为名称的起始字母和终止字母。
  	5.名称必须望文生义。
  	6.名称不得与数据库管理系统保留字冲突。
  	7.不要在对象名的字符之间留空格。

3.2 数据库名

  	1.数据库名定义为库用途名+业务线名称。
  	2.数据库名必须全部采用小写。

3.3 表

  	1.事实表，汇总表采用“dw + 业务线名称 + 表义名”格式构成，中间用下划线隔开。
  	2.中间表（临时表）使用“程序模块名 + 表义名”构成，中间用下划线隔开。
  	3.表名用小写字符。

3.4 字段

  	1.采用有意义的列名，为实际含义的英文单词，用下划线分隔。
  	2.属性名前不要添加表名等作为前缀。
  	3.属性后不加任何类型标识作为后缀。
  	4.不要使用“id”等与系统保留关键字冲突的单词作为列名。

3.5 索引

  	1.索引的命名为直接取列名。须小写。
  	2.不得采用“_”作为名称的起始字母和终止字母。
  	3.名称必须望文生义。
  	4.名称不得与数据库管理系统保留字冲突。
  	5.不要在对象名的字符之间留空格。

3.6 主键

  	1.如果线上表包含主键，线下也要加主键。
  	2.汇总表一般不需要加主键。

3.7 一般性注释

  	1.注释应当简洁，同时应描述清晰。
  	2.注释语法使用/*和*/表示，不要使用单行注释 -- 或者#。
  	3.注释在每个语句之前添加。如有必要，在中间也可以对个别字段的含义做注释。

3.8 select语句

  	将select 语句分为5部分：

		由select 开头，后跟一个显示查询结果的列表；
		由from 开头，后跟一个或多个获取数据所涉及的表；
		由where 开头，后跟一个或多个确定所需值的条件；
		由group by开头，后跟一个或多个表列名，通过这些列以对查询结果进行汇总；
		由order by开头，后跟一个或多个表列名，通过这些列以对查询结果进行排序。
        每个部分分行编写，将每一行的第一个关键字与第一行的select尾部对齐，如

        select col1, col2, col3
          from table1
         where col1 > col2
         group by col1, col2
         order by col1;

       在同一个项目里，关键字的大小写要统一。
       语句中嵌入逗号时，在逗号后面加一空格，当逗号是最后一个字符时，把它放在本行。
       当语句中出现括号时，括号的两边不留空格。
       在sql语句使用运算符时，操作两边应各留一个空格，如

        where x = y and a = b and c = d


3.9 insert语句

  	必须将该表所有的列名列出来，避免出现插入错位或者列数量不匹配。

    insert into table <要插入的表名>(<列1>, <列2>, .., <列n-1>, <列n>)
    values (<列1值>, <列2值>, .., <列n-1值>, <列n值>)

3.10 update语句

    update <要更新的表名> set <要更新的列> = <列值>

3.11 delete语句

    delete from authors where name = 'eric'


以上规范包括MySQL和Hive。

开发人员将SQL文件上传至git仓库后（如/dw_sql /summary_hive_dw_mobile_user_browsing_metrics_daily.sql），
在“配置SQL”选项卡中输入路径和版本 （一般为HEAD），预览并保存即可。

JOB命名规范：

hive脚本为主 MYSQL参考hive脚本

抽取脚本：

1、m2h_table_name Mysql --> Hive

2、h2m_table_name Hive --> Mysql

3、extract_table_name  增量抽取脚本

SQL脚本：

1、summary_hive_dw_table_name Hive汇总JOB

2、load_hive_dw_table_name    Hive加载JOB

项目的运行统一在 192.168.160.45 上进行，可使用项目名称（推荐）或 ID：

```bash
$ java -jar -Dfile.encoding=UTF-8 /home/dwadmin/dwetl/dw_general_loader.jar summary_hive_dw_mobile_user_browsing_metrics_daily
$ java -jar -Dfile.encoding=UTF-8 /home/dwadmin/dwetl/dw_general_loader.jar 117
```

### 常见问题

**文件首条SQL执行失败，提示有未知字符**

原因是创建SQL文件时使用了`UTF-8 + BOM`的格式，这时文件头部会多出一个字符。

解决方法是保存为`UTF-8`格式，即不含`BOM`头，提交后重新保存项目即可。
